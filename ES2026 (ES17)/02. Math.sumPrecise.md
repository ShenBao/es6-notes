# Math.sumPrecise

该提案旨在添加一个名为 Math.sumPrecise(iterable)的新方法，该方法使用一种精度安全的算法来执行数值精确的求和操作。与常用的.reduce((a, b) => a + b)方法不同，Math.sumPrecise 能够避免因浮点舍入而导致的精度损失，生成更为数学上正确的结果。类似于 Python 的 math.fsum 功能，该方法仅接受数字可迭代对象，并在输入为空时返回-0，以保留浮点数的身份规则。

## 关键特性

1. 高精度求和：使用类似 Kahan 求和算法 或更高级的算法（如 Python 的 math.fsum 所用的 Shewchuk 算法），通过跟踪和补偿舍入误差，显著减少累积误差。

2. 处理可迭代对象：接受任何可迭代对象（如数组、Set、Map 的值等）。
    ```js
    Math.sumPrecise([0.1, 0.2]) // => 0.3 (理想结果)
    Math.sumPrecise(new Set([1.1, 2.2, 3.3])) // => 6.6
    ```

3. 空输入返回 -0：这是为了遵循 IEEE 754 浮点数标准中 +0 和 -0 的规则。在某些数学运算中，区分正零和负零是重要的。
    ```js
    Math.sumPrecise([]) // => -0
    ```
4. 类型检查：仅接受包含数字的可迭代对象。如果遇到非数字值，会抛出错误。

```js
let values = [1e20, 0.1, -1e20];

values.reduce((a, b) => a + b, 0); // 0

Math.sumPrecise(values); // 0.1
```

```js
console.log(Math.sumPrecise([1, 2]));
// Expected output: 3

console.log(Math.sumPrecise([1e20, 0.1, -1e20]));
// Expected output: 0.1
```

## 实际应用（当前）

由于该方法尚未在浏览器或 Node.js 中实现，目前无法直接使用。但您可以使用以下替代方案：


使用现有库：
- decimal.js、big.js：提供任意精度的十进制算术。
- mathjs：包含 math.sum 等高精度函数。

手动实现简单版本：
```js
function sumPrecise(iterable) {
    let sum = 0;
    let c = 0; // 补偿误差
    for (const value of iterable) {
        const y = value - c;
        const t = sum + y;
        c = (t - sum) - y;
        sum = t;
    }
    return sum;
}
console.log(sumPrecise([0.1, 0.2])); // 0.3
```

## 链接

- https://github.com/tc39/proposal-math-sum
- https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/sumPrecise
- https://github.com/tc39/proposal-math-sum/blob/main/polyfill/polyfill.mjs
